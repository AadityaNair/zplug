#!/usr/bin/env zsh
# Description:
#   Check if the remote repositories are up to date

local    state arg filter repo
#local -A repo_pids proc_states status_codes repo_dir
local -A repo_pids proc_states hook_build hook_finished hook_pids status_codes repo_dir
local -A tags
local -F SECONDS=0
local -a repos
local -i queue_max=$ZPLUG_THREADS
local -i spinner_idx

while (( $# > 0 ))
do
    arg="$1"
    case "$arg" in
        --select)
            zstyle ':zplug:core:status' 'select' yes
            ;;
        -*|--*)
            __zplug::core::options::unknown "$arg"
            return $status
            ;;
        "")
            # Invalid
            return 1
            ;;
        */*)
            repos+=( "${arg:gs:@::}" )
            ;;
        *)
            return 1
            ;;
    esac
    shift
done

if ! __zplug::core::share::init_parallel --status "$repos[@]"; then
    # Since the initialization has failed, this command is terminated.
    # The error message etc. should be done within that function.
    return 1
fi
repos=( "$reply[@]" )

for repo in "${repos[@]}"
do
    {
        __zplug::core::tags::parse "$repo"
        tags=( "${reply[@]}" )

        if [[ -d $tags[dir] ]]; then
            # Get package status in subprocess
            # Change directory to get the remote status
            __zplug::utils::shell::cd "$tags[dir]"

            case "$tags[from]" in
                "local")
                    status_code=$_zplug_status[status_skip_local_repo]
                    ;;
                "gh-r")
                    __zplug::utils::releases::get_state "$tags[name]" "$tags[dir]"
                    status_code=$status
                    ;;
                *)
                    __zplug::utils::git::get_state "$tags[name]" "$tags[dir]"
                    status_code=$status
                    ;;
            esac
        else
            status_code=$_zplug_status[status_repo_not_found]
        fi

        # Manage the status codes in a file
        # to lock the file in order to write asynchronously
        __zplug::job::handle::flock \
            "$_zplug_config[status_status]" \
            "repo:$repo\tstatus:$status_code"
    } &
    repo_pids[$repo]=$!
    repo_dir[$repo]="$tags[dir]"
    proc_states[$repo]="created"
    status_codes[$repo]=""

    __zplug::job::handle::wait
done

__zplug::core::share::elapsed_time $SECONDS

if (( ${(k)#status_codes[(R)1]} == 0 )); then
    printf "$fg_bold[default] ==> All packages are up-to-date!$reset_color\n"
else
    printf "$fg_bold[red] ==> Run 'zplug update'. These packages are local out of date:$reset_color\n"
    # Listing the packages that have failed to install
    for repo in "${(k)status_codes[@]}"
    do
        if [[ $status_codes[$repo] == 1 ]]; then
            printf " - %s\n" "$repo"
        fi
    done
fi
